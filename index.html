<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EGGnificent Order Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7F8KJ3RJKW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7F8KJ3RJKW');  // Replace GA_MEASUREMENT_ID with yours (e.g., G-ABC123XYZ)
  </script>
  <style>
    body { 
      font-family: "Poppins", sans-serif; 
      background: #fff8e1; 
      color: #333; 
      padding: 20px; 
      max-width: 500px; 
      margin: 0 auto; 
    }
    h1 { text-align: center; color: #d97706; }
    form { display: flex; flex-direction: column; gap: 12px; }
    input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    input[readonly], textarea[readonly] { background-color: #f3f3f3; }
    button { background: #f59e0b; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    button:hover { background: #d97706; }
    #message { text-align: center; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ¥š EGGnificent Orders</h1>
  <form id="orderForm">
    <input type="text" id="name" placeholder="Full Name" required autocomplete="name" />
    <input type="tel" id="phone" placeholder="Phone Number" required autocomplete="tel" />
    <select id="quantity" required>
      <option value="">Select Quantity</option>
      <option value="1 Tray">1 Tray</option>
      <option value="2 Trays">2 Trays</option>
      <option value="3 Trays">3 Trays</option>
      <option value="4 Trays">4 Trays</option>
      <option value="5 Trays">5 Trays</option>
      <option value="6 Trays">6 Trays</option>
      <option value="7 Trays">7 Trays</option>
      <option value="8 Trays">8 Trays</option>
      <option value="9 Trays">9 Trays</option>
      <option value="10 Trays">10 Trays</option>
    </select>
    <select id="payment" required>
      <option value="">Select Payment Method</option>
      <option value="Cash">Cash</option>
      <option value="Card">Card</option>
    </select>
    <select id="delivery" required>
      <option value="">Select Delivery Option</option>
      <option value="Delivery">Delivery</option>
      <option value="Collection">Collection</option>
    </select>
    <textarea id="address" placeholder="Delivery Address" required autocomplete="street-address"></textarea>
    <textarea id="notes" placeholder="Example: 'Bring change for XXX amount' or 'Please deliver at 17h00'" required></textarea>
    <button type="submit">Submit Order</button>
  </form>
    <div id="pricing" style="text-align: center; margin-top: 10px;">
    <div id="loyalty-status" style="color: #d97706; font-weight: bold;">Loyalty: 0/12 trays to freebie</div>
    <div id="total" style="color: #333; font-weight: bold;">Total: R0.00</div>
  </div>
  
  <p id="message"></p>

  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwi8uc_Zc0JYv-1sOfpTJlUSo8SHORCJJ7I_ILrahd8ONzhN_9ARLRRUa26AZCnUD5W/exec";
  const form = document.getElementById("orderForm");
  const deliverySelect = document.getElementById("delivery");
  const addressInput = document.getElementById("address");

  // Pricing & Loyalty function (call on change/submit)
  async function updatePricing() {
    const quantity = document.getElementById("quantity").value;
    const delivery = document.getElementById("delivery").value;
    const payment = document.getElementById("payment").value;
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.toLowerCase();  // For suburb check
    
    if (!quantity || !payment || !delivery) {
      document.getElementById("total").textContent = "Total: R0.00";
      document.getElementById("loyalty-status").textContent = "Loyalty: 0/12 trays to freebie";
      return;
    }
    
    let trays = parseInt(quantity.match(/\d+/)?.[0] || 0);  // Extract number from "2 Trays"
    let base = trays * 65;  // R65/tray
    let deliveryFee = 0;  // Zero-rated base
    let paymentFee = 0;  // Zero-rated always
    let loyaltyDiscount = 0;
    
    // Delivery free only in Eldorado Park or Klipspruit West include key words like Eldos and Klipspruit
    if (delivery === "Delivery" && (address.includes("eldorado park", "Eldos") || address.includes("klipspruit west", "Klipspruit"))) {
      deliveryFee = 0;
    } else if (delivery === "Delivery") {
      deliveryFee = 20;  // Standard fee outside free zones
    }
    
    if (phone) {
      try {
        // Fetch past trays from GAS (new GET endpoint we'll add in Step 3)
        const loyaltyRes = await fetch(scriptURL.replace('/exec', '/dev'), {
          method: 'POST',
          body: JSON.stringify({ action: 'getLoyalty', phone: phone }),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const loyaltyData = await loyaltyRes.json();
        let pastTrays = loyaltyData.pastTrays || 0;
        let pointsToFree = 12 - (pastTrays % 13);  // e.g., 12 total = 1 free on 13th
        document.getElementById("loyalty-status").textContent = `Loyalty: ${pastTrays % 13}/12 trays to freebie`;
        
        if (pastTrays % 13 === 0) {  // Eligible for free tray
          loyaltyDiscount = 65;  // Full R65 off
          document.getElementById("loyalty-status").textContent += " (Free tray unlocked!)";
        }
      } catch (err) {
        console.warn("Loyalty check failed:", err);
        document.getElementById("loyalty-status").textContent = "Loyalty: Check later";
      }
    }
    
    let total = base + deliveryFee + paymentFee - loyaltyDiscount;
    document.getElementById("total").textContent = `Total: R${total.toFixed(2)}`;
    
    // Add to data for sheet/email (use in submit)
    data.total = total;
    data.loyaltyDiscount = loyaltyDiscount;
    data.pointsEarned = trays;  // Track for next time
  }

  // Listen for changes (update on phone/quantity/delivery/payment/address)
  document.getElementById("phone").addEventListener("blur", updatePricing);  // On phone enter
  document.getElementById("quantity").addEventListener("change", updatePricing);
  document.getElementById("delivery").addEventListener("change", updatePricing);
  document.getElementById("payment").addEventListener("change", updatePricing);
  document.getElementById("address").addEventListener("blur", updatePricing);  // On address enter

  // Call on load if form filled
  window.addEventListener("load", updatePricing);

  // Automatically set the address when "Collection" is selected
  deliverySelect.addEventListener("change", () => {
    if (deliverySelect.value === "Collection") {
      addressInput.value = "No 17 Lucas Street Ext 9 Eldorado Park 1811";
      addressInput.readOnly = true;
    } else {
      addressInput.value = "";
      addressInput.readOnly = false;
    }
    updatePricing();  // Recalc total after address change
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const data = {
      name: document.getElementById("name").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      quantity: document.getElementById("quantity").value,
      payment: document.getElementById("payment").value,
      delivery: document.getElementById("delivery").value,
      address: document.getElementById("address").value.trim(),
      notes: document.getElementById("notes").value.trim(),
      total: 0,  // Filled by updatePricing
      loyaltyDiscount: 0,
      pointsEarned: 0
    };

    // Final pricing calc before submit
    updatePricing();

    // Track event optimisticallyâ€”fires every submit
    gtag('event', 'order_submit', {
      'quantity': data.quantity,
      'payment': data.payment,
      'delivery': data.delivery,
      'total': data.total
    });

    // Show success UI immediately
    document.getElementById("message").textContent = "âœ… Order submitted successfully!";
    form.reset();
    addressInput.readOnly = false;

    // Fetch in background (silentâ€”no UI dependency)
    fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "text/plain;charset=utf-8" }
    })
    .then(res => res.json())
    .then(res => {
      if (res.result !== "success") {
        console.warn("Server said: " + res.message);  // Silent log only
      }
    })
    .catch(err => {
      console.error("Silent fetch issue:", err);  // Logs for you
    });
  });
</script>
  

